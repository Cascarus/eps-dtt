{{extend 'dashboard.html'}}
<div class="mt-4">
	<div class="row">
		<div class="col-12 text-center">
			<h3>Enviar email</h3>
		</div>
		<div class="col-12">
			<div class="well span12">	
				<form action="{{=URL('admin', 'mail_notifications/send')}}" method="post">
					<div class="col-12 col-md-6">
						<!--emarquez: control de periodo , -->
						<select name="period" id="period" class="form-control mb-2">
						</select>
						<input id="chkTipoCurso" type="checkbox" checked data-toggle="toggle" data-on="Semestres" data-off="Periodos" data-size="mini">
						<!--emarquez: fin-->
					</div>
					<div class="col-12 mt-2">
						<label for="cc">{{=T('CC')}}</label>
						<input type="text" id="cc" name="cc" value="{{=cc}}" class="form-control"> <a href="#" data-toggle="popover" title="Info" data-content="Los correos en CC deben ir delimitados por ;"><i class="icon-info-sign"></i></a>
					</div>
					<div class="col-12 mt-2">
						<label for="subject">{{=T('Subject')}}</label>
						<input class="subject_class form-control"  type="text" id="subject" name="subject" value="{{=subject}}">
					</div>
					<div class="col-12 mt-2">
						<label for="message">{{=T('Message')}}</label>
						<textarea class="message_class" style="width:99%" id="message" name="message" rows="8">{{=message}}</textarea>
					</div>
					<div class="col-12 mt-2">
						<div id="div_list_attachments" >
							<div class="well">
								<div>
									<a id="attachments" >
									<span class="icon-folder-open"></span>
									{{=T('Attachments')}}
									({{=len(attachment_list)}})
									</a>
									<div  id="attachmentsDiv" value="attachmentsDiv" style="overflow:auto;">
										<table>
										{{for file_var in db(db.uploaded_file.id.belongs(attachment_list)).select():}}
											<tr>
												<td>
													&nbsp &nbsp <input type="checkbox" value="{{= file_var.id }}" name="attachment_list" checked><span class="icon-file"></span><a href="{{=URL('default/download', file_var.file_data)}}" target="blank">  {{=file_var.name}} </a>
												</td>
											</tr>
										{{pass}}
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<button type="submit" class="btn btn-success">{{=T('Send')}}</button>
					<a href="#attachModal" role="button" class="btn btn-primary" data-toggle="modal">
						{{=T('Attach')}} <span class="icon-white icon-upload">
					</a>
			
					<div class="alert alert-primary mt-4">{{=T('Note')}}: {{=T('To send message to DSI users, No course must be selected')}}</div>
					<div class="row">
						<div class="col-12 col-md-4">
							<table class="table-striped table-bordered">
								{{for group in groups:}}
									{{if group.role != "Ecys-Administrator":}}
									<tr>
									<td>
										<input type="checkbox" name="role"
										value="{{=group.id}}">
									</td>
									<td>
										{{=T("Rols "+group.role)}}
									</td>
									</tr>
									{{pass}}
								{{pass}}
							</table>
						</div>
						<div class="col-12 col-md-4">
							<table class="table-striped table-bordered">
								{{for area in areas:}}
									<tr>
									<td>
										<input type="checkbox" class="area_trigger"
										target="{{=prepare_name(area.name)}}" >
									</td>
									<td>
										{{=area.name}}
									</td>
									</tr>
								{{pass}}
							</table>
						</div>
						<div class="col-12 col-md-4">
							{{for area in areas:}}
							<table class="table-striped table-bordered">
								{{for project in get_projects(area).select():}}
								<tr>
									<td>
									<input type="checkbox"
									class="{{=prepare_name(area.name)}}" name="project"
									value="{{=project.id}}">
								</td>
								<td>
									{{=project.name}}
								</td>
								</tr>
								{{pass}}
							</table>
							{{pass}}
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- Attach Div-->
	<div class="modal fade" id="attachModal" tabindex="-1" role="dialog" aria-labelledby="attachModalLbal" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="attachModalLabel">{{=T('Attach file')}}</h5>
			  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			  </button>
			</div>
			<div class="modal-body">
				<ul id="myTab" class="nav nav-tabs">
					<li class="nav-item" id="var_upload"><a class="nav-link active" href="#" data-toggle="tab">{{=T('Upload')}}</a></li>
		   
					 <li class="nav-item" id="var_all"><a class="nav-link" href="#home" data-toggle="tab">{{=T('All files')}}</a></li>
		   
				 </ul>
		   
				 <div id="div_upload" >
					 <form action="" enctype="multipart/form-data" method="post" >
						 {{for file_var in db(db.uploaded_file.id.belongs(attachment_list)).select():}}
						   <input type="hidden" value="{{= file_var.id }}" name="attachment_list">
					   {{pass}}
					   <input class="subject_class"  type="hidden" id="subject" name="subject">
					   <input class="message_class"  type="hidden" id="message" name="message">
					   <input class="cc_class"  type="hidden" name="cc">
						 <div align="center" class="mt-2">
							 <table >
								 <tr>
									 <td align="left">
									   <input name="_formname" type="hidden" value="upload_form">
									   <label>{{=T('File name')}}</label>
									   <input class="string mb-2" name="file_name" type="text" value="">
									   <label>{{=T('Select file')}}</label>
									   <input class="upload" name="file_upload" type="file" id="upload_button">
									   <label>{{=T('is_visible')}}&nbsp &nbsp<input type="checkbox" name="file_visible"></label>
									   <label>{{=T('is_public')}}&nbsp &nbsp<input type="checkbox" name="file_public"></label>
		   
								   </td>
							   </tr>
							   <tr >
								   <td >
									   <div align="right">
										   <input type="submit" class="btn btn-primary" value="{{=T('Upload file')}}">
									   </div>
								   <td>
							   </tr>
						   </table>
					   </div>
				   </form>
				 </div>
				 <div id="div_all" style="display: none;">
					<form   action="#div_list_attachments" enctype="multipart/form-data" method="post" >
						<input name="_formname" type="hidden" value="attach_form">
						{{for file_var in db(db.uploaded_file.id.belongs(attachment_list)).select():}}
							<input type="hidden" value="{{= file_var.id }}" name="attachment_list">
						{{pass}}
						<input class="subject_class"  type="hidden" id="subject" name="subject">
						<input class="message_class"  type="hidden" id="message" name="message">
						<input class="cc_class"  type="hidden" name="cc">
						<div class="well" style="overflow:auto;">
							<div>
								<a id="allFiles" >
								<span class="icon-folder-open"></span>
								{{=T('All files')}}
								</a>
								<div  id="allDiv" value="allDiv" style="overflow:auto;  height:200px; ">
									<table >
										<tr>
											<th>
											</td><th>
												{{=T('Name')}}
											</th><th>
												{{=T('Visible')}}
											</th><th>
												{{=T('is public')}}
											</th>
										</tr>
										{{for all_var in db(db.uploaded_file).select():}}
											<tr>
												<td style="white-space:nowrap;">
													&nbsp &nbsp <input type="checkbox" value="{{=all_var.id}}" name="check_files" >
												</td><td style="white-space:nowrap;">
													<span class="icon-file"></span><a style="white-space:nowrap;" href="{{=URL('default/download', all_var.file_data)}}" target="blank">    {{= all_var.name }} </a>
												</td><td style="white-space:nowrap;">
													- {{=T(str(all_var.visible)) }}
												</td><td style="white-space:nowrap;">
													- {{=T(str(all_var.is_public))}}
												</td></tr>
										{{pass}}
										</table>
										<div  id="div1" value="div1">
										</div>
								</div>
							</div>
						</div>
						<div id="attach_button" style="display: none;" align="right">
							  <input type="submit" role="button" class="btn btn-primary" value="{{=T('Attach')}}">
						</div>
					</form>
			
				</div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
			</div>
		  </div>
		</div>
	  </div>
  <!--Finish Attach Div-->
</div>
{{block page_js}}
<script type="text/javascript">
	$(document).ready(function(){
		$('.area_trigger').click(function(event){
			target = $(this).attr('target');
			$('.'+target).trigger('click');
		})
		$("#attachments").click(function(){
			$("#attachmentsDiv").toggle();
			$("#remove_div").toggle();

		})
		$("#var_all").click(function(){
			$("#div_all").css("display", "block");
			$("#div_upload").css("display", "none");
			$("#attach_button").css("display", "block");

		})
		$("#var_upload").click(function(){
			$("#div_upload").css("display", "block");
			$("#div_all").css("display", "none");
			$("#attach_button").css("display", "none");

		})

		$(".subject_class").keyup(function(){
        	$(".subject_class").val($(this).val());
    	});
    	$(".message_class").keyup(function(){
        	$(".message_class").val($(this).val());
    	});
    	$("#cc").keyup(function(){
        	$(".cc_class").val($(this).val());
		});
		$('[data-toggle="popover"]').popover(); 
	});

	$("#period").append(new Option("Semestre Actual", "0"));
	$('#chkTipoCurso').change(function() {
	if($(this).prop('checked'))
		llenaComboPeriodosSemestres("period");
		else llenaComboPeriodosVariables("period")
	});
</script>
{{end page_js}}