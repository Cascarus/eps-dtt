{{extend 'dashboard.html'}}


<div class="container mt-3">

    <div class="row">
        {{if estado_aplicacion['id_estado_aplicacion'] < 7:}} <div
            class="card col-sm-12 col-md-8 border border-secondary">
            <div class="row card-header bg-dark text-white font-weight-bold ">
                <div class="col-sm-12 col-md-6">
                    <h5>CV Aplicante</h5>
                </div>
            </div>

            <div class="card-body ">
                <div class="row mt-3">
                    <div class="col-sm-12 col-md-4"
                        style="display: flex; align-items: center; justify-content: center;">
                        <img id="img_cv" src="/static/build/images/autoridades/humn.png" alt="No photo">
                    </div>
                    <div class="col-sm-12 col-md-8"
                        style="text-align: center; display: flex; justify-content: center; align-items: center;">
                        <h2 class="mt-2">{{=datos_user['first_name']}} {{=datos_user['last_name']}}</h2>
                    </div>

                </div>

                <div class="row mt-5" style="overflow: auto;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-center text-white font-weight-bold ">
                                Resumen del perfil
                            </div>
                            <div class="card-body">
                                <div class="form-group row">
                                    <div class="col-sm-12 col-xl-4 mt-2">
                                        <label for="edad" class="col-sm-12  col-form-label">Edad:</label>
                                        <input type="text" readonly class=" col-sm-12 form-control mt-1" id="edad"
                                            value="{{=datos_cv['edad']}}">
                                    </div>
                                    <div class="col-sm-12 col-xl-4 mt-2">
                                        <label for="creditos" class="col-sm-12 col-form-label">Creditos
                                            Aprobados:</label>
                                        <input type="text" readonly class="col-sm-12 form-control mt-1" id="creditos"
                                            value="{{=creditos_aprobados}}">
                                    </div>
                                    <div class="col-sm-12 col-xl-4 mt-2">
                                        <label for="creditos" class="col-sm-12 col-form-label">Certificacion de
                                            Cursos:</label>
                                        <button class="col-sm-12 btn btn-primary btn mt-1 text-justify"
                                            onclick="verCertificado('{{=datos_cv['cursos_aprobados']}}')">Ver
                                            certificado</button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>



                <div class="row mt-3" style="overflow: auto;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-center text-white font-weight-bold">
                                Areas de Especialidad
                            </div>
                            <div class="card-body">
                                <div class="row ml-2" style="font-size: 18px;">
                                    {{for area in areas_est:}}
                                    <span class="badge badge-primary mr-1 mt-1">{{=area['area_especialidad']}}</span>
                                    {{pass}}

                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row mt-3">
                    <div class="card col-12 ">
                        <div class="card-header bg-dark text-center text-white font-weight-bold">
                            Experiencia Laboral
                        </div>
                        <div class="card-body">
                            {{for exp in experiencia_lab:}}
                            <div class="card w-95 m-0 p-0">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12  col-xl-8">
                                            <h5 class="card-title">{{=exp['puesto']}}</h5>
                                            <h6 class="card-subtitle mb-2 text-muted">{{=exp['empresa']}}</h6>
                                            <span class="card-subtitle mb-2 text-muted d-block d-xl-none ">
                                                {{=exp['fecha_inicio']}} - {{=exp['fecha_fin']}}
                                            </span>
                                            <p>{{=exp['descripcion']}}</p>
                                        </div>
                                        <div class="col-xl-4 d-none d-xl-block ">
                                            <label for="">{{=exp['fecha_inicio']}} - {{=exp['fecha_fin']}}</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{pass}}
                        </div>
                    </div>
                </div>




                <div class="row mt-3" style="overflow: auto;">
                    <div class="card col-12">
                        <div class="card-header bg-dark text-center text-white font-weight-bold">
                            Cursos y Certificaciones
                        </div>
                        <div class="card-body">
                            {{for cert in certificaciones:}}
                            <div class="card w-95">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 col-xl-8">
                                            <h5 class="card-title">{{=cert['nombre_certificacion']}}</h5>
                                            <span class="card-subtitle mb-2 text-muted d-block d-xl-none ">
                                                {{=cert['fecha_expedicion']}}
                                            </span>
                                            {{if(cert['tipo']==1):}}
                                            {{archivo = cert['enlace']}}
                                            <button class="btn btn-primary btn-sm"
                                                onclick='verCertificado("{{=archivo}}")'>
                                                Ver Credencial
                                            </button>
                                            {{else:}}
                                            <a class="btn btn-primary btn-sm" href="{{=cert['enlace']}}"
                                                class="card-link" target="_blank">Ver Credencial</a>
                                            {{pass}}
                                        </div>
                                        <div class="col-12 col-xl-4 d-none d-xl-block">
                                            <label for="">{{=cert['fecha_expedicion']}}</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{pass}}
                        </div>
                    </div>
                </div>



                <div class="row mt-3" style="overflow: auto;">
                    <div class="card col-12">
                        <div class="card-header bg-dark text-center text-white font-weight-bold">
                            Habilidades Tecnicas
                        </div>
                        <div class="card-body">
                            <div class="row ml-2" style="font-size: 18px;">
                                {{for hab in habilidades_usuario:}}
                                <span class="badge badge-primary mr-1 mt-1">{{=hab['habilidad']}}</span>
                                {{pass}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    <div class="col-sm-12 col-md-4  ">
        <div class="row mt-3" style="overflow: auto;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-center text-white font-weight-bold">
                        Informacion de Contacto
                    </div>
                    <div class="card-body">
                        <div class="form-group row">
                            <label for="correo" class="col-sm-12 col-md-4  col-form-label">Correo:</label>
                            <input type="text" readonly class="col-sm-12  col-md-8 form-control-plaintext " id="correo"
                                value="{{=datos_cv['correo']}}">
                        </div>
                        <div class="form-group row">
                            <label for="telefono" class="col-sm-12 col-md-4 col-form-label">Telefono:</label>
                            <input type="text" readonly class="col-sm-12 col-md-8 form-control-plaintext" id="telefono"
                                value="{{=datos_cv['telefono']}}">
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-center text-white font-weight-bold">
                        Estado de Aplicacion
                    </div>
                    <div class="card-body">
                        <div class="row" style="font-size: xx-large;">
                            {{id_estado=estado_aplicacion['id_estado_aplicacion']}}
                            {{if id_estado < 5:}} <p class='badge badge-primary col-sm-12'>
                                {{=estado_aplicacion['estado_aplicacion']}}
                            </p>
                                {{elif id_estado < 7:}} <p class='badge badge-success col-sm-12'>
                                    {{=estado_aplicacion['estado_aplicacion']}}
                                </p>
                                    {{else:}}
                                    <p class='badge badge-danger col-sm-12'>
                                        {{=estado_aplicacion['estado_aplicacion']}}
                                    </p>
                                    {{pass}}
                        </div>
                        <div class="form-group row mt-1">
                            <p id="emailHelp" class="form-text text-muted" style="font-size: medium;">
                                Recuerda que el proceso de aplicación sigue el siguiente flujo:</p>
                            <ol style="margin-left: 6%;">
                                {{if estado_aplicacion['id_estado_aplicacion'] == 1:}}
                                <li style="font-weight: bold; background-color: yellow;">Aplicacion Enviada</li>
                                {{else:}}
                                <li>Aplicacion Enviada</li>
                                {{pass}}
                                {{if estado_aplicacion['id_estado_aplicacion'] == 2:}}
                                <li style="font-weight: bold; background-color: yellow;">Aplicacion Revisada</li>
                                {{else:}}
                                <li>Aplicacion Revisada</li>
                                {{pass}}

                                {{if estado_aplicacion['id_estado_aplicacion'] == 3:}}
                                <li style="font-weight: bold; background-color: yellow;">Aplicante Contactado</li>
                                {{else:}}
                                <li>Aplicante Contactado</li>
                                {{pass}}

                                {{if estado_aplicacion['id_estado_aplicacion'] == 4:}}
                                <li style="font-weight: bold; background-color: yellow;">Aplicante Contratado</li>
                                {{else:}}
                                <li>Aplicante Contratado</li>
                                {{pass}}
                            </ol>
                            <p id="emailHelp" class="form-text text-muted" style="font-size: medium;">
                                En caso de que no sea posible
                                continuar con el proceso de aplicacion, puedes dar por terminado el proceso dando
                                click en "Finalizar Proceso"</p>
                        </div>

                        <div class="form-group row mt-2">
                            {{id_usuario = datos_cv['id_estudiante_cv']}}
                            {{correo= datos_cv['correo']}}

                            {{if id_estado < 4:}} <button class="btn btn-primary btn-sm ml-1 col-12 mt-1"
                                class="card-link"
                                onclick='actualizarEstado("{{=id_usuario}}","{{=id_oferta}}",0,"{{=correo}}")'>
                                Avanzar Proceso
                                </button>
                                <button class="btn btn-success btn-sm ml-1 col-12 mt-1" class="card-link"
                                    onclick='actualizarEstado("{{=id_usuario}}","{{=id_oferta}}",1,"{{=correo}}")'>Finalizar
                                    Proceso
                                </button>
                                <button class="btn btn-danger btn-sm ml-1 col-12 mt-1" class="card-link"
                                    onclick='cancelarAplicacion("{{=id_usuario}}","{{=id_oferta}}",0,"{{=correo}}")'>Cancelar
                                    Contratación</button>
                                {{elif id_estado < 5:}} <button class="btn btn-success btn-sm ml-1 col-12 mt-1"
                                    class="card-link"
                                    onclick='actualizarEstado("{{=id_usuario}}","{{=id_oferta}}",1,"{{=correo}}")'>
                                    Finalizar Proceso</button>
                                    <button class="btn btn-danger btn-sm ml-1 col-12 mt-1" class="card-link"
                                        onclick='cancelarAplicacion("{{=id_usuario}}","{{=id_oferta}}",1,"{{=correo}}")'>Despedir</button>
                                    {{else:}}
                                    <button class="btn btn-danger btn-sm ml-1 col-12 mt-1" class="card-link"
                                        onclick='cancelarAplicacion("{{=id_usuario}}","{{=id_oferta}}",1,"{{=correo}}")'>Despedir</button>
                                    {{pass}}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    {{else:}}
    <p>No tiene permisos para ver este CV</p>
    {{pass}}
</div>

<style>
    #img_cv {
        height: 150px;
        width: 150px;
        border-radius: 50%;
    }
</style>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

    function verCertificado(certificado) {
        var fd = new FormData();
        fd.append("documento_cv", certificado);

        $.ajax({

            url: "/oferta_laboral/obtener_cv",
            type: "POST",
            data: fd,
            success: function (resp) {
                downloadPDF(resp)
            },
            cache: false,
            contentType: false,
            processData: false,


        });
    }

    function downloadPDF(pdf) {
        const linkSource = `data:application/pdf;base64,${pdf}`;
        const downloadLink = document.createElement("a");
        const fileName = "Certificado.pdf";
        downloadLink.href = linkSource;
        downloadLink.download = fileName;
        downloadLink.click();
    }

    function actualizarEstado(id_estudiante, id_oferta, finalizar, correo) {
        $.ajax({
            url: "/oferta_laboral/estado_proceso",
            type: "POST",
            data: {
                id_estudiante: id_estudiante,
                id_oferta: id_oferta,
                finalizar: finalizar,
                correo: correo
            },
            success: function (resp) {
                resp = JSON.parse(resp)
                if (resp.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Estado Actualizado!'
                    })
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al actualizar el Estado',
                        text: resp.msg
                    })
                }
            },
            error: function (resp) {
                console.log(resp)
                esp = JSON.parse(resp)
                Swal.fire({
                    icon: 'error',
                    title: 'Error al actualizar el Estado',
                    text: resp.msg
                })
            }
        });
    }
    function cancelarAplicacion(id_estudiante, id_oferta, despedido, correo) {
        $.ajax({
            url: "/oferta_laboral/cancelar_contratacion",
            type: "POST",
            data: {
                id_estudiante: id_estudiante,
                id_oferta: id_oferta,
                despedido: despedido,
                correo: correo
            },
            success: function (resp) {
                console.log(resp)
                resp = JSON.parse(resp)
                if (resp.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Estado Actualizado!'
                    })
                    location.reload();
                    console.log(location.toString())
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al actualizar el Estado',
                        text: resp.msg
                    })
                }
            },
            error: function (resp) {
                esp = JSON.parse(resp)
                Swal.fire({
                    icon: 'error',
                    title: 'Error al actualizar el Estado',
                    text: resp.msg
                })
            }
        });
    }
</script>