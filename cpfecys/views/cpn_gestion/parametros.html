{{if log_parametros!="":}}
<center>
    <span id="information_text" class="badge badge-important">{{=log_parametros}}</span>
</center>
{{pass}}
<h2>Gestión hoja de calificación</h2>
{{if estado_hoja==True:}}
<b>Estado: <font color="green">Completo</font></b>
{{else:}}
<b>Estado: <font color="red">Incompleto</font></b>
{{pass}}
<div>
    <center>

        {{if array_hoja!=None:}}
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <td style="font-style: italic; background-color:#E6E6FA;" width="55%"><b>Descripción de la
                            ponderación</b></td>
                    <td style="font-style: italic; background-color:#E6E6FA;" width="10%"><b>{{=T('Grade')}}</b></td>
                    <td style="font-style: italic; background-color:#E6E6FA;" width="10%"
                        title="{{=T('Average Grades')}}"><b>{{=T('AG')}}</b></td>
                    <td style="font-style: italic; background-color:#E6E6FA;" width="20%"><b>{{=T('Actions')}}</b></td>
                </tr>
            </thead>
            <!-- ******************* ITERANDO CATEGORIAS *********************** -->
            {{for categoria in array_hoja:}}
            <tr id="{{=categoria['idcat']}}">
                <td> <!-- Nombre de la categoria-->
                    {{if (update=='3') & (categoria['idcat']==idcat):}}
                    <input class="string" type="text" value="{{=categoria['categoria']}}" id="edit_categoria"
                        style="width:80%;">
                    {{else:}}
                    <b>{{=categoria['categoria']}}</b>
                    {{pass}}
                </td>
                <td> <!-- Nota de la categoria-->
                    {{if (update=='3') & (categoria['idcat']==idcat):}}
                    <input class="string" type="text" value="{{=categoria['nota']}}" id="edit_nota" style="width:30px;">
                    {{else:}}
                    {{if categoria['estado']=='True':}}
                    <b>
                        <font color="green">{{=categoria['nota']}}</font>
                    </b>
                    {{else:}}
                    <b>
                        <font color="red">{{=categoria['nota']}}</font>
                    </b>
                    {{pass}}
                    {{pass}}
                </td>
                <td> <!-- Promediar categoria-->
                    {{if (update=='3') & (categoria['idcat']==idcat):}}
                    {{if categoria['avg'] =='True':}}
                    <input type="checkbox" name="edit_SG_check" id="edit_SG_check" checked>
                    {{else:}}
                    <input type="checkbox" name="edit_SG_check" id="edit_SG_check">
                    {{pass}}
                    {{else:}}
                    {{if categoria['avg']=='True':}}
                    Si
                    {{else:}}
                    No
                    {{pass}}
                    {{pass}}
                </td>
                <td style="text-align: right;"> <!-- Acciones de la categoria-->
                    {{if (update=='3') & (categoria['idcat']==idcat):}}
                    <a id="categoryButton" role="button" class="badge btn-success"
                        onclick="updateCategory('{{=categoria['idcat']}}');">
                        <span class="fa fa-check"></span>
                    </a>
                    {{else:}}
                    <a id="categoryButton" role="button" class="badge btn-info"
                        onclick="editCategory('{{=categoria['idcat']}}');">
                        <span class="fa fa-pencil"></span>
                    </a>
                    {{pass}}
                    <a id="parameterButton" role="button" class="badge btn-info"
                        onclick="addParamRow('{{=categoria['idcat']}}');" title="Agregar parámetro">
                        <span class="fa fa-plus"></span>
                    </a>
                    <a id="categoryButton" role="button" class="badge btn-danger"
                        onclick="removeCategory('{{=categoria['idcat']}}');"
                        title="{{=T('Remove weighting category')}}">
                        <span class="fa fa-times"></span>
                    </a>
                </td>
            </tr>
            <!-- *********************** ITERANDO PARAMETRO DE LA CATEGORIA **********************-->
            <!-- Cargando filas de los parametros de las categorías -->
            {{if len(categoria['parametros'])>0:}}
            {{for parametro in categoria['parametros']:}}
            <tr>
                {{if (update=='8') & (categoria['idcat']==idcat) & (parametro['idparam']==idparam):}}
                <td> <!-- Nombre parametro, editando-->
                    <input class="string" type="text" value="{{=parametro['parametro']}}" id="edit_param"
                        style="width:80%;">
                </td>
                {{if categoria['avg']=='False':}}
                <td> <!-- Nota parametro, editando-->
                    <input class="string" type="text" value="{{=parametro['nota']}}" id="edit_nota_param"
                        style="width:30px;">
                </td>
                {{else:}}
                <td style="text-align: right;">{{=parametro['nota']}}</td>
                {{pass}}
                {{else:}}
                <td>- {{=parametro['parametro']}}</td> <!-- Nombre parametro-->
                <td style="text-align: right;">{{=parametro['nota']}}</td> <!-- Nota parametro-->
                {{pass}}
                <td></td> <!-- Celda vacía parametro-->
                <td style="text-align: right;"> <!-- Acciones parametro-->
                    {{if (update=='8') & (categoria['idcat']==idcat) & (parametro['idparam']==idparam):}}
                    <a id="paramButton" role="button" class="badge btn-success"
                        onclick="updateParam('{{=categoria['idcat']}}', '{{=parametro['idparam']}}', '{{=categoria['avg']}}');">
                        <span class="fa fa-check"></span>
                    </a>
                    {{else:}}
                    <a id="paramButton" role="button" class="badge btn-info"
                        onclick="editParam('{{=categoria['idcat']}}', '{{=parametro['idparam']}}');">
                        <span class="fa fa-pencil"></span>
                    </a>
                    {{pass}}
                    <a id="paramButton" role="button" class="badge btn-danger"
                        onclick="removeParam('{{=categoria['idcat']}}', '{{=parametro['idparam']}}');"
                        title="{{=T('Remove weighting category')}}">
                        <span class="fa fa-times"></span>
                    </a>
                </td>
            </tr>
            {{pass}}
            {{pass}}
            <!-- *********************** TERMINA ITERANDO PARAMETRO DE LA CATEGORIA **********************-->
            <!-- Agregando fila para nuevo parámetro -->
            {{if (update=='5') & (categoria['idcat']==idcat):}}
            <tr>
                <td>
                    <input class="string" type="text" id="save_param" style="width:80%;">
                </td>
                <td>
                    {{if categoria['avg']== 'False':}}
                    <input class="string" type="text" id="save_nota_param" style="width:30px;">
                    {{pass}}
                </td>
                <td></td>
                <td>
                    <a role="button" class="badge btn-success"
                        onclick="saveParameter('{{=categoria['idcat']}}', '{{=categoria['avg']}}');">
                        <span class="fa fa-check"></span>
                    </a>
                </td>
            </tr>
            {{pass}}
            {{pass}}
            <!-- ************************ TERMINA ITERAR  CATEGORIAS ********************** -->
            <tr>
                <td style="background-color:#E6E6FA;">
                    {{=T('Total')}}
                </td>
                <td style="background-color:#E6E6FA;">
                    {{if total_hoja < 100:}} <b>
                        <font color="red">{{=total_hoja}}</font></b>
                        {{else:}}
                        <b>
                            <font color="green">{{=total_hoja}}</font>
                        </b>
                        {{pass}}
                </td>
                <td style="background-color:#E6E6FA;">
                </td>
                <td style="background-color:#E6E6FA;">
                </td>
            </tr>
        </table>

        {{else:}}
        <table class="table table-striped table-bordered">
            <tr>
                <th>
                    Descripción de la ponderación
                </th>
                <th>
                    {{=T('Grade')}}
                </th>
                <th title="{{=T('Average Grades')}}">
                    {{=T('AG')}}
                </th>
                <th>
                    {{=T('Actions')}}
                </th>
            </tr>
            <tr>
                <td style="background-color:#eee;">
                    {{=T('Total')}}
                </td>
                <td style="background-color:#eee;">
                    0
                </td>
                <td style="background-color:#eee;">
                </td>
                <td style="background-color:#eee;">
                </td>
            </tr>
        </table>
        </table>

        {{pass}}
    </center>
</div>

<script type="text/javascript">
    var project = {{=request.vars['project']}};
    var activity = {{=request.vars['activity']}};
    var actname = "{{=request.vars['actname']}}";
    var acttype = "{{=request.vars['acttype']}}";
    var year = {{=request.vars['year']}};

    function removeCategory(idcat) {
        if (confirm("Se eliminará la categoría y todos los items que contiene. ¿Continuar?")) {
            $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                "?project=" + encodeURIComponent(project) +
                "&activity=" + encodeURIComponent(activity) +
                "&actname=" + encodeURIComponent(actname) +
                "&acttype=" + encodeURIComponent(acttype) +
                "&year=" + encodeURIComponent(year) +
                "&update=2" +
                "&idcat=" + encodeURIComponent(idcat));
        }
    }
    function editCategory(idcat) {
        $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
            "?project=" + encodeURIComponent(project) +
            "&activity=" + encodeURIComponent(activity) +
            "&actname=" + encodeURIComponent(actname) +
            "&acttype=" + encodeURIComponent(acttype) +
            "&year=" + encodeURIComponent(year) +
            "&update=3" +
            "&idcat=" + encodeURIComponent(idcat));
    }
    function updateCategory(idcat) {
        var categoria = $("#edit_categoria").val();
        var nota = $("#edit_nota").val();
        var promediar = ($("#edit_SG_check").prop('checked') == true) ? "True" : "False";
        var updated_category = '{"idcat":"' + idcat + '", "categoria":"' + categoria + '", "nota":"' + nota + '", "avg":"' + promediar + '", "parametros":[]}';

        if (categoria != "" && nota != "") {
            var regex = /^\d+(?:\.\d{0})$/;
            var regex2 = /^([0-9])*$/;

            if (parseInt(nota) != 0 && (regex.test(nota) || regex2.test(nota))) {
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=4" +
                    "&idcat=" + encodeURIComponent(idcat) +
                    "&value=" + encodeURIComponent(updated_category));
            } else {
                alert("La cantidad ingresada en la nota no es válida.");
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=0");
            }
        } else {
            alert("Debe completar todos los campos.");
            $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                "?project=" + encodeURIComponent(project) +
                "&activity=" + encodeURIComponent(activity) +
                "&actname=" + encodeURIComponent(actname) +
                "&acttype=" + encodeURIComponent(acttype) +
                "&year=" + encodeURIComponent(year) +
                "&update=0");
        }
    }

    function addParamRow(idcat) {
        //alert(idcat);
        $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
            "?project=" + encodeURIComponent(project) +
            "&activity=" + encodeURIComponent(activity) +
            "&actname=" + encodeURIComponent(actname) +
            "&acttype=" + encodeURIComponent(acttype) +
            "&year=" + encodeURIComponent(year) +
            "&update=5" +
            "&idcat=" + encodeURIComponent(idcat));
    }
    function saveParameter(idcat, avg) {
        var parametro = $("#save_param").val();
        var nota_param = $("#save_nota_param").val();

        if (avg == "False") {
            if (parametro != "" && nota_param != "") {
                var regex = /^\d+(?:\.\d{0,2})$/;
                var regex2 = /^([0-9])*$/;

                if (String(nota_param) != '0' && (regex.test(nota_param) || regex2.test(nota_param))) {
                    //var new_parameter = '{"idparam":"", "parametro":"", "nota":""}';
                    var new_parameter = '"parametro":"' + parametro + '", "nota":"' + nota_param + '"}';
                    //alert("si pasé XD "+new_parameter);
                    $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                        "?project=" + encodeURIComponent(project) +
                        "&activity=" + encodeURIComponent(activity) +
                        "&actname=" + encodeURIComponent(actname) +
                        "&acttype=" + encodeURIComponent(acttype) +
                        "&year=" + encodeURIComponent(year) +
                        "&update=6" +
                        "&idcat=" + encodeURIComponent(idcat) +
                        "&value=" + encodeURIComponent(new_parameter));
                } else {
                    alert("La cantidad ingresada en la nota no es válida.");
                    $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                        "?project=" + encodeURIComponent(project) +
                        "&activity=" + encodeURIComponent(activity) +
                        "&actname=" + encodeURIComponent(actname) +
                        "&acttype=" + encodeURIComponent(acttype) +
                        "&year=" + encodeURIComponent(year) +
                        "&update=0");
                }
            } else {
                alert("Debe completar todos los campos.");
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=0");
            }
        } else { //Cuanto está activado promediar notas
            if (parametro != "") {
                var new_parameter = '"parametro":"' + parametro + '", "nota":"0"}';
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=6" +
                    "&idcat=" + encodeURIComponent(idcat) +
                    "&value=" + encodeURIComponent(new_parameter));
            } else {
                alert("Debe completar todos los campos.");
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=0");
            }
        }
    }

    function removeParam(idcat, idparam) {
        if (confirm("¿Desea eliminar el parámetro seleccionado?")) {
            $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                "?project=" + encodeURIComponent(project) +
                "&activity=" + encodeURIComponent(activity) +
                "&actname=" + encodeURIComponent(actname) +
                "&acttype=" + encodeURIComponent(acttype) +
                "&year=" + encodeURIComponent(year) +
                "&update=7" +
                "&idcat=" + encodeURIComponent(idcat) +
                "&idparam=" + encodeURIComponent(idparam));
        }
    }

    function editParam(idcat, idparam) {
        //alert("soy editParam "+ idcat +" "+ idparam);
        $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
            "?project=" + encodeURIComponent(project) +
            "&activity=" + encodeURIComponent(activity) +
            "&actname=" + encodeURIComponent(actname) +
            "&acttype=" + encodeURIComponent(acttype) +
            "&year=" + encodeURIComponent(year) +
            "&update=8" +
            "&idcat=" + encodeURIComponent(idcat) +
            "&idparam=" + encodeURIComponent(idparam));
    }
    function updateParam(idcat, idparam, avg) {
        //alert("soy updateParam "+ idcat +" "+ idparam);
        var parametro = $("#edit_param").val();
        var nota_param = $("#edit_nota_param").val();

        if (avg == 'False') {
            if (parametro != "" && nota_param != "") {
                var regex = /^\d+(?:\.\d{0,2})$/;
                var regex2 = /^([0-9])*$/;

                if (String(nota_param) != '0' && (regex.test(nota_param) || regex2.test(nota_param))) {
                    //var new_parameter = '{"idparam":"", "parametro":"", "nota":""}';
                    var updated_parameter = '{"idparam":"' + idparam + '","parametro":"' + parametro + '", "nota":"' + nota_param + '"}';
                    //alert("si pasé XD "+updated_parameter);
                    $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                        "?project=" + encodeURIComponent(project) +
                        "&activity=" + encodeURIComponent(activity) +
                        "&actname=" + encodeURIComponent(actname) +
                        "&acttype=" + encodeURIComponent(acttype) +
                        "&year=" + encodeURIComponent(year) +
                        "&update=9" +
                        "&idcat=" + encodeURIComponent(idcat) +
                        "&idparam=" + encodeURIComponent(idparam) +
                        "&value=" + encodeURIComponent(updated_parameter));
                } else {
                    alert("La cantidad ingresada en la nota no es válida.");
                    $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                        "?project=" + encodeURIComponent(project) +
                        "&activity=" + encodeURIComponent(activity) +
                        "&actname=" + encodeURIComponent(actname) +
                        "&acttype=" + encodeURIComponent(acttype) +
                        "&year=" + encodeURIComponent(year) +
                        "&update=0");
                }
            } else {
                alert("Debe completar todos los campos.");
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=0");
            }
        } else {
            if (parametro != "") {
                var updated_parameter = '{"idparam":"' + idparam + '","parametro":"' + parametro + '", "nota":"0"}';
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=9" +
                    "&idcat=" + encodeURIComponent(idcat) +
                    "&idparam=" + encodeURIComponent(idparam) +
                    "&value=" + encodeURIComponent(updated_parameter));
            } else {
                alert("Debe completar todos los campos.");
                $("#div_parametros").load("{{=URL('cpn_gestion', 'parametros.html')}}" +
                    "?project=" + encodeURIComponent(project) +
                    "&activity=" + encodeURIComponent(activity) +
                    "&actname=" + encodeURIComponent(actname) +
                    "&acttype=" + encodeURIComponent(acttype) +
                    "&year=" + encodeURIComponent(year) +
                    "&update=0");
            }
        }
    }
</script>