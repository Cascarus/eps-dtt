{{extend 'dashboard.html'}}
{{import cpfecys}}
{{import datetime}}
<div class="mt-4 col-12">
    <a onclick="window.history.back()" class="btn btn-primary">
        <i class="icon-arrow-left"></i>Atras
    </a>
    <h2 class="mt-4">
        <center>
            Asignación de practica final: <small>{{=final_practice.project.name}}</small>
        </center>
    </h2>
    <hr>
    <h3 class="mt-2"><center>Información del estudiante</center></h3>
    <ul class="col-12">
        <li>Usuario: {{=final_practice.auth_user.username}}</li>
        <li>Nombres: {{=final_practice.auth_user.first_name}}</li>
        <li>Apellidos: {{=final_practice.auth_user.last_name}}</li>
    </ul>
    <hr>
    <h3 class="mt-2"><center>Asignación</center></h3>
    <ul class="col-12">
        <li>Área: {{=final_practice.area_level.name}}</li>
        <li>Proyecto: {{=final_practice.project.name}}</li>
        <li>Fecha de asignación: Semestre {{=final_practice.period_year.period}} - {{=final_practice.period_year.yearp}}</li>
        <li>
            Duración de la asignación: {{=final_practice.user_project.periods}} semestre(s)
        </li>
    </ul>
    <hr>
    <h3 class="mt-2"><center>Nota de los reportes</center></h3>
    <div class="well">
        <div class="accordion" id="reports_accordion">
            <div class="accordion-group">
                {{for item in available_periods:}}
                    {{reports, reports_avg = get_current_reports(item)}}
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#reports_accordion" href="#r{{=item.id}}">
                            {{=item.yearp}} - Semestre {{=item.period}}
                            <span class="right">
                                <span>Nota promedio: {{=int(reports_avg)}}</span> |
                                <span>Reportes entregados: {{=len(reports)}}</span>
                            </span>
                        </a>
                    </div>
                    <div id="r{{=item.id}}" class="accordion-body collapse">
                        <div class="accordion-inner">
                            <table class="table table-striped table-bordered" style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Nombre del reporte</th>
                                        <th>Fecha de entrega</th>
                                        <th>Estado</th>
                                        <th>Nota</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{for report in reports:}}
                                        <tr>
                                            <td>{{=report.report_restriction['name']}}</td>
                                            <td>{{=report.created}}</td>
                                            <td>{{=T(report.status['name'])}}</td>
                                            <td>{{=report.score or 0}}</td>
                                            <td>
                                                <a class="btn btn-primary" href="{{=URL('teacher', 'report/view', vars=dict(report=report.id))}}"> 
                                                    <span class="icon-eye-open"></span>Ver reporte
                                                </a>
                                            </td>
                                        </tr>
                                    {{pass}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {{pass}}
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12 well">
            <h3>Entregables</h3>
            {{for pyear in assignation_range(final_practice):}}
                <h5>{{=T(pyear.period.name)}} - {{=pyear.yearp}}</h5>
                <table style="width:100%;" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Fecha de creación (Año-Mes-Día)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{item_restrictions = available_item_restriction(pyear, final_practice).select(
                                                db.item_restriction.id,
                                                db.item_restriction.name,
                                                db.item_restriction.limit_days
                                            )
                        }}
                        {{for item_restriction in item_restrictions:}}
                            {{if restriction_project_exception(item_restriction.id, assignation.project.id).count() == 0:}}
                                {{if cpfecys.current_year_period().id == pyear.id:}}
                                    {{instance = items_instance(item_restriction.id, final_practice.user_project.id)}}
                                    {{instance = instance.select(db.item.item_restriction, db.item.created, db.item.uploaded_file, db.item.item_restriction).first()}}
                                    {{if instance is not None:}}
                                        {{if not instance.item_restriction.hidden_from_teacher:}}
                                            <tr>
                                                <td>
                                                    {{=instance.item_restriction.name}}
                                                </td>
                                                <td>
                                                    {{=T(instance.created.period.name)}} 
                                                    {{=instance.created.yearp}}
                                                </td>
                                                <td>
                                                    {{if instance.item_restriction.item_type.name == 'File':}}
                                                        <a class="btn btn-primary" href="{{=URL('cpfecys/teacher', 'download', instance.uploaded_file)}}">
                                                            <span class="icon-eye-open"></span>Ver elemento
                                                        </a>
                                                    {{elif instance.item_restriction.item_type.name == 'Activity':}}
                                                        {{if instance.done_activity == True:}}
                                                            <div class="label label-success">
                                                                Completado    
                                                            </div>
                                                        {{else:}}
                                                            <div class="label label-important">
                                                                Fallido    
                                                            </div>
                                                        {{pass}}
                                                    {{elif instance.item_restriction.item_type.name == 'Grade Activity':}}
                                                        <span style="display: none;"></span>
                                                    {{pass}}
                                                </td>
                                            </tr>
                                        {{pass}}
                                    {{else:}}
                                        <tr>
                                            <td>{{=item_restriction.name}}</td>
                                            <td>
                                                {{last_day = None}}
                                                {{if item_restriction.limit_days is not None:}}                                        
                                                    {{cyearperiod = cpfecys.current_year_period()}}
                                                        {{if cyearperiod.period == cpfecys.first_period.id:}}
                                                            {{last_day = str(datetime.timedelta(days = item_restriction.limit_days) + datetime.date(cyearperiod.yearp,1,1))}}
                                                    {{else:}}
                                                            {{last_day = str(datetime.timedelta(days = item_restriction.limit_days) + datetime.date(cyearperiod.yearp,6,1))}}
                                                    {{pass}}
                                                {{pass}}
                                                {{status_class = 'info'}}
                                                {{message_status = T('Not delivered yet')}}
                                                {{if last_day is not None and compare_last_day(last_day):}}
                                                    {{status_class = 'important'}}
                                                    {{message_status = T('No delivered')}}
                                                {{pass}}
                                                <div class="label label-{{=status_class}}">
                                                {{=message_status}} , {{=T('Last day')}}: 
                                                    {{=last_day or T('Semester ending')}}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="label label-info">
                                                    {{=T('Pending')}}
                                                </div>
                                            </td>
                                        </tr>
                                    {{pass}}
                                {{pass}}
                            {{pass}}
                        {{pass}}
                    </tbody>
                </table>
            {{pass}}
        </div>
    </div>
</div>