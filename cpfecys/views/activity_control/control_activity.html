{{from datetime import datetime}}
{{import cpfecys}}

{{total_var2 = 0}}
{{activityPermition = 0}}
{{if type == "class":}}
	{{weighting1 =  db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project.id) & (db.course_activity_category.laboratory==False)).select()}}
{{else:}}
	{{weighting1 =  db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project.id) & (db.course_activity_category.laboratory==True)).select()}}
{{pass}}

{{for category in weighting1:}}
	{{total_var2 = float(total_var2) + float(category.grade)}}
	{{if category.teacher_permition:}}
		{{activityPermition = activityPermition + 1}}
	{{pass}}				
{{pass}}

{{if request.vars['operation'] == "div_update":}}
	{{if auth.has_membership('Student') and assigned_to_project and type == "lab":}}
		{{enddate = None}}
		<!--emarquez: adaptacion periodos variables -->
		{{if cpfecys.is_semestre(semestre2.id):}} 			
			{{for date_var in db((db.student_control_period.period_name == T(str(semester))+" "+str(year))).select():}}
				{{if datetime.now() > date_var.date_start and datetime.now() < date_var.date_finish:}}
					{{enddate = date_var.date_finish}}					
				{{pass}}
			{{pass}}
			{{if enddate != None:}}
				<center><font color="red">{{=T('Deadline for entry activities with specific notes')}}: {{=enddate}}</font></center>
			{{pass}}
		{{else:}}
			{{for date_var in db((db.period_detail.period==cpfecys.get_period_from_periodyear(request.vars['year']))).select():}}
				{{if datetime.now() > date_var.date_start and datetime.now() < date_var.date_finish:}}
					{{enddate = date_var.date_finish}}					
				{{pass}}
			{{pass}}
			{{if enddate != None:}}
				<center><font color="red">{{=T('Deadline for entry activities with specific notes')}}: {{=enddate}}</font></center>
			{{pass}}
		{{pass}}
	{{pass}}
	<center>
		{{if float(total_var2) == 100:}}
			<div id="table_activity">
				<center>{{=T('Loading')}}...</center>
			</div>
		{{else:}}
			{{if (auth.has_membership('Student') or auth.has_membership('Teacher')) and assigned_to_project:}}
				<b><font color="red">{{=T('You must first create the weighting')}}</font></b>
			{{else:}}
				<b><font color="red">{{=T('Exist a problem in the weighting, the activities can not show')}}</font></b>
			{{pass}}
		{{pass}}
	</center>
{{pass}}

{{if request.vars['operation'] == "menu_update":}}
	{{var_do = 'false'}}
	{{if auth.has_membership('Student'):}}
		<!--Check that the current date is in the period that de administrator has register-->		
		<!--emarquez: adaptacion periodos variables -->
		{{if cpfecys.is_semestre(semestre2.id):}} 
			{{for date_var in db((db.student_control_period)).select():}}
				{{if datetime.now() >= date_var.date_start and datetime.now() <= date_var.date_finish:}}
					{{var_do = 'true'}}					
				{{pass}}
			{{pass}}
			{{if var_do == 'false':}}
				{{extraTime = db(db.course_limit_exception.project==project.id).select().first()}}
				{{if extraTime is not None:}}
					{{if datetime.now() >= date_var.date_start and datetime.now() <= extraTime.date_finish:}}
						{{var_do = 'true'}}
					{{pass}}
				{{pass}}		
			{{pass}}
		{{else:}}	
			{{for date_var in db((db.period_detail)).select():}}
				{{if datetime.now() >= date_var.date_start and datetime.now() <= date_var.date_finish:}}
					{{var_do = 'true'}}					
				{{pass}}
			{{pass}}
			{{if var_do == 'false':}}
				{{extraTime = db(db.course_limit_exception_period.project==project.id).select().first()}}
				{{if extraTime is not None:}}
					{{if datetime.now() >= date_var.date_start and datetime.now() <= extraTime.date_finish:}}
						{{var_do = 'true'}}
					{{pass}}
				{{pass}}		
			{{pass}}  
        {{pass}}
		<!--End of the check of period-->
	{{pass}}

	<!--emarquez: adaptacion periodos variables-->
	{{if cpfecys.is_semestre(semestre2.id):}} 
		{{exception_query = db(db.course_laboratory_exception.project == project.id).select().first()}}
		{{exception_s_var = False}}
		{{exception_t_var = False}}
		{{no_menu = True}}

		{{if exception_query is not None:}}
			{{exception_t_var = exception_query.t_edit_lab}}
			{{exception_s_var = exception_query.s_edit_course}}
		{{pass}}
	{{else:}}
		{{exception_query = db(db.course_laboratory_exception_period.project == project.id).select().first()}}
		{{exception_s_var = False}}
		{{exception_t_var = False}}
		{{no_menu = True}}

		{{if exception_query is not None:}}
			{{exception_t_var = exception_query.t_edit_lab}}
			{{exception_s_var = exception_query.s_edit_course}}
		{{pass}}	
	{{pass}}

	{{if (auth.has_membership('Super-Administrator')) or (auth.has_membership('Teacher') and request.vars['type'] == "class"  and assigned_to_project) or (auth.has_membership('Student') and request.vars['type'] == "lab"  and assigned_to_project) or (auth.has_membership('Student')  and request.vars['type'] == "class" and (exception_s_var  or activityPermition > 0)  and assigned_to_project) or (auth.has_membership('Teacher')  and request.vars['type'] == "lab" and exception_t_var  and assigned_to_project):}}
		{{no_menu = False}}
	{{pass}}

	<ul class="dropdown"  class="close" aria-hidden="true"  title="Menu">
		<a class="dropdown-toggle btn btn-info" data-toggle="dropdown" href="">
	    	<i class="fa fa-bars" aria-hidden="true"></i>
	  	</a>
	  	<h3 class="icon-white" style="text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;">
			Planificaci√≥n
		</h3> 
		<ul class="dropdown-menu">  
		<!-- emarquez: adaptaciones periodos variables -->

		{{periods_control = False}}
		{{if cpfecys.is_semestre(semestre2.id):}}
			{{if cpfecys.current_year_period().id == semestre2.id:}}
				{{periods_control = True}}
			{{pass}}
		{{else:}}
			{{periods_control = True}}
		{{pass}}


	  	{{no_actions = False}}	  	

	  	{{if periods_control:}}
	  		{{course_ended_var = db((db.course_ended.project==project) & (db.course_ended.period==semestre2.id)).select().first()}}
			{{if course_ended_var != None:}}
				{{if course_ended_var.finish:}}
					{{no_actions = True}}
				{{pass}}
			{{pass}}
			{{if no_actions == False:}}
			  	{{if no_menu == False:}}
					  	<!--Create activity option-->
				  		{{if float(total_var2) == 100:}}
				  			{{if request.vars['type'] == "lab":}}
				  				{{weighting = db((db.request_change_weighting.status == 'pending') & (db.request_change_weighting.project == request.vars['project']) & (db.request_change_weighting.period == request.vars['year'])).select().first()}}
								{{if weighting != None:}}
									<li class="dropdown-item disabled"> 
										<a  tabindex="-1" title="{{=T('Create activity')}}" id="menu_create_activity">
								{{else:}}
									<li class="dropdown-item">
										<a  tabindex="-1" title="{{=T('Create activity')}}" id="menu_create_activity" href="{{=URL('activity_control', 'students_control_full',vars=dict(project = request.vars['project'], year = request.vars['year'], f_view='activity_edit',type=request.vars['type']))}}">
								{{pass}}
				  			{{else:}}
				  				<li class="dropdown-item">
									<a  tabindex="-1" title="{{=T('Create activity')}}" id="menu_create_activity" href="{{=URL('activity_control', 'students_control_full',vars=dict(project = request.vars['project'], year = request.vars['year'], f_view='activity_edit',type=request.vars['type']))}}">
				  			{{pass}}
						{{else:}}
							<li class="dropdown-item disabled"> 
								<a  tabindex="-1" title="{{=T('Create activity')}}" id="menu_create_activity">
						{{pass}}
						<i class="fa fa-plus-circle" aria-hidden="true"></i>{{=T('Create Activity')}}
							</a>
						</li>
						<!--Create activity option-->

						<!--Edit activity option-->
				      	{{if float(total_var2) == 100 and auth.has_membership('Student') and request.vars['type'] == "lab":}}
				      		{{if var_do == 'true':}}
				      			{{weighting = db((db.request_change_weighting.status == 'pending') & (db.request_change_weighting.project == request.vars['project']) & (db.request_change_weighting.period == request.vars['year'])).select().first()}}
								{{if weighting != None:}}
									<li class="dropdown-item disabled"> 
										<a tabindex="-1"  title="{{=T('Modify activity')}}">
								{{else:}}
									<li class="dropdown-item">
										<a tabindex="-1"  title="{{=T('Modify activity')}}" id="menu_edit_activity" href="{{=URL('activity_control', 'students_control_full',vars=dict(project = request.vars['project'], year = request.vars['year'], f_view='activity_edit',type=request.vars['type']))}}"> 
								{{pass}}
							{{else:}}
								<li class="dropdown-item disabled"> 
									<a tabindex="-1"  title="{{=T('Modify activity')}}">
							{{pass}}
						{{elif float(total_var2) == 100:}}
							{{if request.vars['type'] == "lab":}}
				  				{{weighting = db((db.request_change_weighting.status == 'pending') & (db.request_change_weighting.project == request.vars['project']) & (db.request_change_weighting.period == request.vars['year'])).select().first()}}
								{{if weighting != None:}}
									<li class="dropdown-item disabled"> 
										<a tabindex="-1"  title="{{=T('Modify activity')}}">
								{{else:}}
									<li class="dropdown-item">
										<a tabindex="-1"  title="{{=T('Modify activity')}}" id="menu_edit_activity" href="{{=URL('activity_control', 'students_control_full',vars=dict(project = request.vars['project'], year = request.vars['year'], f_view='activity_edit',type=request.vars['type']))}}">
								{{pass}}
				  			{{else:}}
				  				<li class="dropdown-item">
									<a tabindex="-1"  title="{{=T('Modify activity')}}" id="menu_edit_activity" href="{{=URL('activity_control', 'students_control_full',vars=dict(project = request.vars['project'], year = request.vars['year'], f_view='activity_edit',type=request.vars['type']))}}">
				  			{{pass}}
						{{else:}}
							<li class="dropdown-item disabled"> 
								<a tabindex="-1"  title="{{=T('Modify activity')}}">
						{{pass}}
								<i class="fa fa-pencil-square-o" aria-hidden="true"></i>
					          {{=T('Edit Activity')}}
					        </a>
					     </li>
					     <!--Edit activity option-->

					     <!--Validate Laboratory option-->
						{{if request.vars['type'] == "lab":}}
							{{if float(total_var2) == 100:}}
				  				<li class="dropdown-item">
									<a  tabindex="-1" title="{{=T('Validate Laboratory')}}" aria-hidden="true" href="{{=URL('activity_control', 'validate_laboratory',vars=dict(project = request.vars['project'], year = request.vars['year']))}}" >
							{{else:}}
								<li class="dropdown-item disabled">
									<a  tabindex="-1" title="{{=T('Validate Laboratory')}}">
							{{pass}}
								<i class="fa fa-check" aria-hidden="true"></i>{{=T('Validate Laboratory')}}
								</a>
							</li>
						{{pass}}
						<!--Validate Laboratory option-->

						 <!--Laboratory replacing option-->
						{{if request.vars['type'] == "lab":}}
							{{if float(total_var2) == 100:}}
				  				<li class="dropdown-item">
									<a  tabindex="-1" title="{{=T('Laboratory Equivalence')}}" aria-hidden="true" href="{{=URL('activity_control', 'laboratory_replacing',vars=dict(project = request.vars['project'], year = request.vars['year']))}}" >
							{{else:}}
								<li class="dropdown-item disabled">
									<a  tabindex="-1" title="{{=T('Laboratory Equivalence')}}">
							{{pass}}
								<i class="fa fa-certificate" aria-hidden="true"></i>{{=T('Laboratory Equivalence')}}
								</a>
							</li>
						{{pass}}
						<!--Laboratory replacing option-->

					{{if auth.has_membership('Student') and request.vars['type'] == "lab":}}
					     <!--Change request option-->
				    	{{if var_do == 'false' and float(total_var2) == 100:}}
				    		<li class="dropdown-item">
				    			<a role="button" title="{{=T('Request that the changes be reviewed by the professor or administrator')}}" aria-hidden="true" href="{{=URL('activity_control', 'request_change_activity',vars=dict(project = request.vars['project'], year = request.vars['year']))}}" >
									<i class="fa fa-random" aria-hidden="true"></i>
									a
									{{=T('Change Request')}}
								</a>
							</li>
				    	{{else:}}
				    		<li class="dropdown-item disabled"> 
								<a tabindex="-1"  title="{{=T('Request that the changes be reviewed by the professor or administrator')}}">
									<i class="fa fa-random" aria-hidden="true"></i>
									a
						          {{=T('Change Request')}}
						        </a>
					      	</li>
				    	{{pass}}
					    <!--Change request option-->
				    {{pass}}
				{{pass}}
			{{elif not no_menu:}}
				 <!--Validate Laboratory option-->
				{{if request.vars['type'] == "lab":}}
					{{if float(total_var2) == 100:}}
		  				<li class="dropdown-item">
							<a  tabindex="-1" title="{{=T('Validate Laboratory')}}" aria-hidden="true" href="{{=URL('activity_control', 'validate_laboratory',vars=dict(project = request.vars['project'], year = request.vars['year']))}}" >
					{{else:}}
						<li class="dropdown-item disabled">
							<a  tabindex="-1" title="{{=T('Validate Laboratory')}}">
					{{pass}}
						<i class="fa fa-check" aria-hidden="true"></i>{{=T('Validate Laboratory')}}
						</a>
					</li>
				{{pass}}
				<!--Validate Laboratory option-->

				<!--Laboratory replacing option-->
				{{if request.vars['type'] == "lab":}}
					{{if float(total_var2) == 100:}}
		  				<li class="dropdown-item">
							<a  tabindex="-1" title="{{=T('Laboratory Equivalence')}}" aria-hidden="true" href="{{=URL('activity_control', 'laboratory_replacing',vars=dict(project = request.vars['project'], year = request.vars['year']))}}" >
					{{else:}}
						<li class="dropdown-item disabled">
							<a  tabindex="-1" title="{{=T('Laboratory Equivalence')}}">
					{{pass}}
						<i class="fa fa-certificate" aria-hidden="true"></i>{{=T('Laboratory Equivalence')}}
						</a>
					</li>
				{{pass}}
				<!--Laboratory replacing option-->
			{{pass}}
		{{pass}}


		{{if float(total_var2) == 100:}}
		    <li class="dropdown-item">
				<a tabindex="-1"  title="{{=T('General Report of Activities')}}" href="{{=URL('activity_control', 'general_report_activities',vars=dict(project = request.vars['project'], period = request.vars['year'], type=request.vars['type']))}}"> 
					<i class="fa fa-file" aria-hidden="true"></i>
				{{=T('General Report of Activities')}}
				</a>
			</li>
		{{else:}}
			<li class="dropdown-item disabled"> 
				<a tabindex="-1"  title="{{=T('General Report of Activities')}}" href="{{=URL('activity_control', 'general_report_activities',vars=dict(project = request.vars['project'], period = request.vars['year'], type=request.vars['type']))}}"> 
					<i class="fa fa-file" aria-hidden="true"></i>
				{{=T('General Report of Activities')}}
				</a>
			</li>
		{{pass}}


	  </ul>
	</ul> 
{{pass}}

<script type="text/javascript">
  	$(document).ready(function(){
		$("#table_activity").load("{{=URL('activity_control', 'activity.html')}}?op=showTableNoEditable&amp;project={{=request.vars['project']}}&amp;year={{=request.vars['year']}}&amp;type={{=request.vars['type']}}");

		$("#menu_edit_activity").click(function(){
	      $("#div_activity_show").load("{{=URL('activity_control', 'activity.html')}}?op=showEditTable&amp;project={{=request.vars['project']}}&amp;year={{=request.vars['year']}}&amp;type={{=request.vars['type']}}"); 
	    })
	});
</script>
