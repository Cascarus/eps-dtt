{{extend 'dashboard.html'}}
<div class="mt-4">
	<div class="row">
		<div class="col-12 text-center">
			<h1>{{=T('Change Request Control')}}</h1>
		</div>
		<div class="col-12 mt-3">
			<!--emarquez-->
			<form class="form-inline" action="{{=URL('activity_control', 'courses_list_request')}}" method='get'>
				<select id="period" name="period" class="form-control"></select>
				<input class="btn btn-primary" type="submit" value="{{=T('Go')}}">
			</form>
			<!--emarquez: fin-->
			<div  class="well table-responsive mt-3">
				<table class="table table-striped table-bordered">
					<thead>
						<th>{{=T('Project')}}</th>
						<th>{{=T('Section')}}</th>
						<th><center>{{=T('Weighting Request')}}</center></th>
						<th><center>{{=T('Activity Request')}}</center></th>
						<th><center>{{=T('Grades Request')}}</center></th>
					</thead>
					<tbody>
						{{for course in courses_request:}}
							{{if auth.has_membership('Teacher'):}}
								{{if (str(course.user_project.project.id) == request.vars['project']) or (request.vars['type'] == None):}}
									<tr>
										<td>{{=split_name(course.user_project.project.name)}}</td>
										<td>{{=split_section(course.user_project.project.name)}}</td>
										<td>
											<center>
												{{var_count = db((db.request_change_weighting.status == 'pending') & (db.request_change_weighting.period == int(semester_id.id))
																& (db.request_change_weighting.project == course.user_project.project)).count()}}
												<a class="{{="btn btn-info" if var_count == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_weighting', vars=dict(course=course.user_project.project))}}">
													{{=T('View')}} ({{=var_count}})
												</a>
											</center>
										</td>
										<td>
											<center>
												{{var_count = db((db.requestchange_activity.status == 'pending') & (db.requestchange_activity.semester == int(semester_id.id))
																& (db.requestchange_activity.course == course.user_project.project)).count()}}
												<a class="{{="btn btn-info" if var_count == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_activity', vars=dict(course=course.user_project.project))}}">
													{{=T('View')}} ({{=var_count}})
												</a>
											</center>
										</td>
										<td>
											<center>
												{{var_count = db((db.request_change_grades.status == 'pending') & (db.request_change_grades.period == int(semester_id.id))
																& (db.request_change_grades.project == course.user_project.project)).count()}}
												<a class="{{="btn btn-info" if var_count == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_grades', vars=dict(course=course.user_project.project))}}">
													{{=T('View')}} ({{=var_count}})
												</a>
											</center>
										</td>
									</tr>
								{{pass}}
							{{else:}}
								{{var_count = db((db.request_change_weighting.status == 'pending') & (db.request_change_weighting.period == int(semester_id.id))
											& (db.request_change_weighting.project == course.id)).count()}}
								{{var_count_2 = db((db.requestchange_activity.status == 'pending') & (db.requestchange_activity.semester == int(semester_id.id))
											& (db.requestchange_activity.course == course.id)).count()}}
								{{var_count_3 = db((db.request_change_grades.status == 'pending') & (db.request_change_grades.period == int(semester_id.id))
											& (db.request_change_grades.project == course.id)).count()}}
								{{if (var_count != 0) | (var_count_2 != 0) | (var_count_3 != 0):}}
									<tr>
										<td>{{=split_name(course.name)}}</td>
										<td>{{=split_section(course.name)}}</td>
										<td>
											<center>
												<a class="{{="btn btn-info" if var_count == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_weighting', vars=dict(course=course.id))}}">
													{{=T('View')}} ({{=var_count}})
												</a>
											</center>
										</td>
										<td>
											<center>
												<a class="{{="btn btn-info" if var_count_2 == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_activity', vars=dict(course=course.id))}}">
													{{=T('View')}} ({{=var_count_2}})
												</a>
											</center>
										</td>
										<td>
											<center>
												<a class="{{="btn btn-info" if var_count_3 == 0 else "btn btn-warning"}}" href="{{=URL('activity_control', 'solve_request_change_grades', vars=dict(course=course.id))}}">
													{{=T('View')}} ({{=var_count_3}})
												</a>
											</center>
										</td>
									</tr>
								{{pass}}
							{{pass}}
						{{pass}}
					</tbody>
					<tfoot>
						<tr>
							<td colspan='6'>
								<div align="left">
									<b>{{=T('Legend')}}:</b>
									<br>
									<span class="badge badge-warning">&nbsp;&nbsp;&nbsp;</span>{{=T('There are pending requests')}}
									<br>
									<span class="badge badge-info">&nbsp;&nbsp;&nbsp;</span>{{=T('There are no pending requests')}}
									<br>
									*{{=T('Inside the parentheses the number of pending requests is shown')}}
									<br>
								</div>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>
</div>

<script type ="text/javascript">
	var _URLPERIOD_VARIABLE = "/cpfecys/admin/get_periodos_variables"
	var _URLPERIOD_SEMESTRE = "/cpfecys/admin/get_periodos_semestre"
	var _URLNOTIFICATION_NUMBER = "/notification/get_notification_number"
	var _URL_PERIODS = "/cpfecys/admin/get_periodos"
	var PERIODOS_VARIABLES;
	var PERIODOS_SEMESTRE;
	var periodo = "{{=request.vars['period']}}"
	var tipo_periodo = "{{=request.vars['tipo_periodo']}}"

	$(document).ready(function(){
		var periodo = "{{=request.vars['period']}}"
		var tipo_periodo = "{{=request.vars['chkTipoCurso']}}"
		//verificar que parametros vienen para setear el chek y el combo
		llenaComboPeriodosSemestres("period"); $("#period").val(periodo);
	});

	function llenaComboPeriodosSemestres(idCombo){
		$("#" + idCombo).empty();
		$.each(PERIODOS_SEMESTRE, function(index, data){
			var o = new Option(data.period.name + "-" + data.period_year.yearp, data.period_year.id);
			$("#" + idCombo).append(o);
		});
	}
</script>